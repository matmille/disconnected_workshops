---
# Unstable and still in development
- name: Build Setup
  user: root
  hosts: all

  tasks:
  - name: Install prerequisite RPM packages on hypervisor host
    yum:
      name: "{{ item }}"
      state: present
    with_items:
      - git
      - gitweb
      - git-daemon
      - httpd
      - libselinux-python
      - libvirt-client
      - libvirt-daemon
      - libvirt-daemon-driver-qemu
      - libvirt-python
      - nfs-utils
      - policycoreutils-python
      - python-lxml
      - qemu-img
      - qemu-kvm
      - qemu-kvm-common
      - qemu-kvm-tools
      - rpcbind
      - samba
      - virt-install
      - virt-manager
    tags:
      - hypervisor_setup

  - name: Enable Port for HTTP communication in SELinux
    seport:
      ports: "{{ www_port }}"
      proto: tcp
      setype: http_port_t
      state: present
    ignore_errors: yes
    tags:
      - hypervisor_setup

  - name: Stage Apache HTTPD kickstart configuration file
    template:
      src: "{{ www_file_configuration_ks_template }}"
      dest: "/etc/httpd/conf.d/{{ www_file_configuration_ks }}"
      owner: root
      group: root
      mode: 0644
    tags:
      - hypervisor_setup

  - name: Create kickstart configuration file directory available via web service
    file:
      path: "{{ kickstart_directory }}"
      state: directory
      owner: apache
      group: apache
      mode: 0775
    tags:
      - hypervisor_setup

  - name: Stage kickstart configuration file for guest network configuration installations
    template:
      src: "{{ kickstart_file_configuration_template }}"
      dest: "{{ kickstart_directory }}/{{ kickstart_file_configuration }}"
      owner: apache
      group: apache
      mode: "a=r"

  - name: Set SELinux context of kickstart file
    sefcontext:
      target: "{{ kickstart_directory }}/{{ kickstart_file_configuration }}"
      setype: httpd_sys_content_t
      state: present
    ignore_errors: yes

  - name: Run restore context to reload SELinux
    shell: "restorecon -Rv {{ kickstart_directory }}"

  - name: Create share directory to export deliverables to end-user
    file:
      path: "{{ share_directory }}"
      state: directory
      owner: nobody
      group: nobody
      mode: 0775
    tags:
      - hypervisor_setup

  - name: Create Ansible Tower Bundle directory
    file:
      path: "{{ share_directory }}/ansible"
      state: directory
      owner: nobody
      group: nobody
      mode: 0775
    tags:
      - hypervisor_setup

  - name: Ensure Ansible Tower is staged
    stat:
      path: "{{ share_directory }}/{{ ansible_tower_bundle_file }}"
    register: ansible_tower_download

  - name: Download Ansible Tower Bundle
    get_url:
      url: "{{ ansible_tower_bundle_base_url }}/{{ ansible_tower_bundle_file }}"
      dest: "{{ share_directory }}/{{ ansible_tower_bundle_file }}"
    when: ansible_tower_download.stat.exists == False

  - name: UnTar Ansible Tower Bundle
    unarchive:
      src: "{{ share_directory }}/{{ ansible_tower_bundle_file }}"
      dest: "{{ share_directory }}/ansible"
      extra_opts: "--strip-components=1"

  - name: Lorax (build RHEL7 ISO)
    shell: "setenforce 0; lorax --noverifyssl -p RHEL -v 7 -r 4 -s https://cdn.redhat.com/content/dist/rhel/server/7/4/x86_64/os {{ share_directory }}; setenforce 1"

  - name: Create git projects directory
    file:
      path: "{{ git_projects }}"
      state: directory
      owner: nobody
      group: nobody
      mode: 0775
    tags:
      - hypervisor_setup

  - name: Start Kernel Virtual Machine (KVM) service (libvirtd)
    service:
      name: libvirtd
      state: started
      enabled: yes
    register: kvm
    tags:
      - hypervisor_setup

  - name: Wait for libvirtd to start
    pause:
      seconds: 120
    when: kvm.changed
    tags:
      - hypervisor_setup

  - name: Query Kernel Virtual Machine to get a list of private networks
    virt_net:
      command: list_nets
    register: kvm_networks
    tags:
      - hypervisor_setup

  - name: List existing Kernel Virtual Machine networks
    debug:
      msg: "{{ kvm_networks.list_nets }}"
    tags:
      - hypervisor_setup

  - name: Create private network
    virt_net:
      command: define
      name: "{{ kvm_private_network_name }}"
      xml: '{{ lookup("template", "templates/hypervisor/private-net.xml.j2") }}'
      autostart: yes
      state: present
    when: kvm_private_network_name not in kvm_networks.list_nets
    tags:
      - hypervisor_setup

  - name: Start private network
    virt_net:
      command: start
      name: private
    when: kvm_private_network_name not in kvm_networks.list_nets
    tags:
      - hypervisor_setup

  - name: Start GIT daemon
    service:
      name: git.socket
      state: started
      enabled: yes
    tags:
      - hypervisor_setup

  - name: re-Start GIT daemon (to ensure latest configuration is loaded)
    service:
      name: git.socket
      state: restarted
      enabled: yes
    tags:
      - hypervisor_setup

  - name: Open firewall port(s) for GIT tcp
    firewalld:
      port: "9148/tcp"
      permanent: true
      state: enabled
    tags:
      - hypervisor_setup

  - name: Open firewall port(s) for GIT udp
    firewalld:
      port: "9148/udp"
      permanent: true
      state: enabled
    tags:
      - hypervisor_setup

  - name: Open firewall port(s) for GIT Web
    firewalld:
      port: "{{ git_port }}/tcp"
      permanent: true
      state: enabled
    tags:
      - hypervisor_setup

  - name: Start Apache HTTPD - Web Service (required for kickstart for network configuration)
    service:
      name: httpd
      state: started
      enabled: yes
    tags:
      - hypervisor_setup

  - name: re-Start Apache HTTPD (to ensure latest configuration is loaded)
    service:
      name: httpd
      state: restarted
      enabled: yes
    tags:
      - hypervisor_setup

  - name: Open firewall port for Apache HTTPD
    firewalld:
      port: "{{ www_port }}/tcp"
      permanent: true
      state: enabled
    tags:
      - hypervisor_setup

  - name: Stage NFS configuration
    template:
      src: "{{ exports_file_configuration_template }}"
      dest: "/etc/{{ exports_file_configuration }}"
      owner: root
      group: root
      mode: 0644
    tags:
      - hypervisor_setup

  - name: Start NFS service
    service:
      name: nfs
      state: started
      enabled: yes
    tags:
      - hypervisor_setup

  - name: re-Start NFS service (ensure latest configuraiton is loaded)
    service:
      name: nfs
      state: restarted
      enabled: yes
    tags:
      - hypervisor_setup

  - name: Open firewall port for NFS
    firewalld:
      service: "{{ item }}"
      permanent: true
      state: enabled
    with_items:
      - nfs
      - mountd
      - rpc-bind
    tags:
      - hypervisor_setup

  - name: Stage Samba configuration file
    template:
      src: "{{ samba_file_configuration_template }}"
      dest: "/etc/samba/{{ samba_file_configuration }}"
      owner: root
      group: root
      mode: 0644
    tags:
      - hypervisor_setup

  - name: Start Samba to provide SMB/CIFS networking service
    service:
      name: smb
      state: started
      enabled: yes
    tags:
      - hypervisor_setup

  - name: re-Start Samba (to ensure latest configuration is loaded)
    service:
      name: smb
      state: restarted
      enabled: yes
    tags:
      - hypervisor_setup

  - name: Open firewall port(s) for Samba
    firewalld:
      service: samba
      permanent: true
      state: enabled
    tags:
      - hypervisor_setup

  - name: Reload firewalld
    service:
      name: firewalld
      state: reloaded
      enabled: yes
    tags:
      - hypervisor_setup

  - name: Set SELinux context of shared directory
    sefcontext:
      target: "{{ share_directory }}(/.*)?"
      setype: samba_share_t
      state: present
    ignore_errors: yes
    tags:
      - hypervisor_setup

  - name: Run restore context to reload SELinux
    shell: "restorecon -Rv {{ share_directory }}"
    tags:
      - hypervisor_setup

  - name: Get list of Virtual Machines available on the host
    virt:
      command: list_vms
    register: vms

  - name: Display Virtual Machine list (debugging purposes)
    debug:
      msg: "{{ item }}"
    with_items:
      - "{{ vms.list_vms }}"

  - name: false
    command: /bin/false

  - name: Create Virtual Machine
    shell: virt-install -n "{{ item.name }}"
           -r "{{ item.mem }}"
           --location "{{ item.url }}"
           --vcpus "{{ item.cpu }}"
           --os-type "{{ item.os.type }}"
           --os-variant "{{ item.os.variant }}"
           --network=network:"{{ kvm_private_network_name}}",model=e1000
           --graphics spice
           --"{{ item.virt_hypervisor }}"
           --virt-type "{{ item.virt_type }}"
           --disk size="{{ item.disk.size }}",path="{{ item.disk.path }}/{{ item.name }}".qcow2,format=qcow2
           --disk path="{{ item.url }}",device=cdrom
           --extra-args="ks=http://{{ kvm_private_network_ip }}:{{ www_port }}/{{ kickstart_file_configuration}} ip=dhcp"
           --check path_in_use=off
    when: item.name not in vms.list_vms
    with_items:
      - "{{ guests }}"

  - name: Allow time for newly created Virtual Machine to boot
    pause:
      minutes: 1

  - name: Query KVM for environment/VM details
    virt:
      command: info
    register: virt_info

  - name: Ensure all created Virtual Machines are running
    virt:
      name: "{{ item.name }}"
      command: start
    when: virt_info[item.name]['state'] != 'running'
    with_items:
      - "{{ guests }}"

  - name: Wait for all Virtual Machines to enter running state
    virt:
      command: info
    register: virt_info
    until: virt_info[item.name]['state'] == 'running'
    retries: 1500
    delay: 10
    with_items:
      - "{{ guests }}"

  - name: Display each Virtual Machine and its IP address
    debug:
      msg: "{{ item }}"
    with_items:
      - "{{ vms.list_vms }}"

  - name: Query Hypervisor
    virt:
      command: info
    register: virt_info
    tags:
      - vm_clean

  - name: Display output of Hypervisor query
    debug:
      msg: "{{ virt_info }}"
    tags:
      - vm_clean
